# STM32F030 LED 时钟 用户手册

## 目录

1. [产品概述](#1-产品概述)
2. [硬件规格](#2-硬件规格)
3. [显示说明](#3-显示说明)
4. [按键操作](#4-按键操作)
5. [功能详解](#5-功能详解)
6. [设置流程](#6-设置流程)
7. [技术参数](#7-技术参数)
8. [常见问题](#8-常见问题)

---

## 1. 产品概述

本时钟基于 **STM32F030F4** 微控制器，配备 **TM1637 驱动的 4 位 LED 数码管**，具有以下功能：

- ⏰ **实时时钟显示**（时：分）
- ⏱️ **秒数显示**
- 🌡️ **温度显示**（自动切换）
- ⏰ **闹钟功能**
- 🔔 **整点报时**
- 💡 **自动/手动亮度调节**

### 核心芯片

| 芯片型号 | 功能说明 |
|---------|---------|
| STM32F030F4 | 主控制器，ARM Cortex-M0 内核 |
| SD3077 | RTC 实时时钟芯片，带备份寄存器 |
| TM1637 | LED 数码管驱动芯片 |

---

## 2. 硬件规格

### 2.1 引脚定义

```c
// 按键引脚
#define MODE_KEY_PIN    // 模式键 - 切换显示模式和进入设置
#define SET_KEY_PIN     // 设置键 - 调整数值

// 蜂鸣器引脚
#define BUZZER_PIN      // 有源蜂鸣器控制

// RTC 中断引脚
#define SEC_INT_Pin     // 秒中断输入，用于时间同步
```

### 2.2 传感器

| 传感器 | 类型 | 说明 |
|-------|------|------|
| 光敏电阻 | ADC 通道 0 | 自动亮度检测 |
| NTC 热敏电阻 | ADC 通道 1 | 环境温度检测 |

---

## 3. 显示说明

### 3.1 显示模式

| 显示内容 | 示例 | 说明 |
|---------|------|------|
| 时间模式 | `12:30` | 正常显示当前时间（时：分） |
| 秒数模式 | `  45` | 显示当前秒数 |
| 温度模式 | ` 25C` | 显示当前环境温度 |

### 3.2 设置模式显示

| 模式 | 显示示例 | 说明 |
|-----|---------|------|
| 设置小时 | `  23` | 闪烁位为当前设置的小时 |
| 设置分钟 | `12  ` | 闪烁位为当前设置的分钟 |
| 闹钟开关 | `AL oF` / `AL On` | 闹钟关闭/开启 |
| 设置闹钟小时 | `  08` | 闪烁位为闹钟小时 |
| 设置闹钟分钟 | `08  ` | 闪烁位为闹钟分钟 |
| 温度显示时长 | `TS 05` | 温度显示 5 秒 |
| 温度隐藏时长 | `TH 10` | 温度隐藏 10 秒 |
| 亮度设置 | `br AU` / `br 05` | 自动/手动亮度 5 级 |
| 强光亮度 | `b1 08` | 强光下亮度 8 级 |
| 弱光亮度 | `b2 01` | 弱光下亮度 1 级 |
| 整点报时开关 | `ro oF` / `ro On` | 整点报时关闭/开启 |
| 报时开始时间 | `rS 08` | 8:00 开始报时 |
| 报时结束时间 | `re 20` | 20:00 结束报时 |

---

## 4. 按键操作

### 4.1 按键定义

| 按键 | 功能 |
|-----|------|
| **MODE 键** | 切换显示模式 / 进入设置 / 确认下一步 |
| **SET 键** | 调整数值 / 切换秒数显示 |

### 4.2 按键操作方式

| 操作 | 判定时间 | 功能 |
|-----|---------|------|
| 短按 | > 50ms | 单击功能 |
| 长按 | > 800ms | 长按功能 / 快速调整 |
| 长按保持 | 每 250ms | 连续调整数值 |

### 4.3 操作流程图

```
正常显示状态
    │
    ├── MODE 短按 → 进入时间设置模式
    │
    └── SET 短按 → 切换秒数显示

设置状态
    │
    ├── MODE 短按 → 进入下一设置项
    │
    ├── SET 短按 → 数值 +1
    │
    ├── SET 长按 → 数值快速 +1
    │
    └── MODE 长按 → 退出设置，返回正常显示
```

---

## 5. 功能详解

### 5.1 时间显示模式

**默认显示模式**，显示当前时间（时：分）。

- **显示格式**：`HH:MM`（4 位数码管，中间冒号分隔）
- **时间范围**：00:00 - 23:59
- **自动切换**：可配置温度显示自动切换

### 5.2 秒数显示模式

按 **SET 键** 从时间模式切换到秒数显示。

- **显示格式**：`  SS`（后两位显示秒数）
- **秒数重置**：在秒数显示模式下按 **MODE 键**，秒数归零

### 5.3 温度显示模式

温度显示可与时间模式自动切换。

- **显示格式**：` XXC`（XX 为温度值，范围 0-99℃）
- **温度检测**：NTC 热敏电阻，8 次采样平均滤波
- **自动切换**：
  - 显示时间 → 等待 `tempertureHideTime` 秒 → 显示温度
  - 显示温度 → 等待 `tempertureShowTime` 秒 → 显示时间

### 5.4 闹钟功能

#### 5.4.1 闹钟设置

1. 进入闹钟设置模式
2. 设置闹钟开关（`AL On` / `AL oF`）
3. 设置闹钟小时（0-23）
4. 设置闹钟分钟（0-59）

#### 5.4.2 闹钟响铃

- **触发条件**：当前时间 = 闹钟时间 且 闹钟已开启
- **响铃模式**：
  - 4 声短音（50ms 响，50ms 停）
  - 休息 500ms
  - 循环重复
- **停止方式**：按任意键停止

#### 5.4.3 代码逻辑

```c
void checkAlarm() {
    if (alarmHour == time.hours && alarmMin == time.minutes &&
        isAlarmed == false && isAlarmEnabled) {
        alarmStart();  // 触发闹钟
    }
    if (alarmHour != time.hours || alarmMin != time.minutes) {
        if (isAlarming) {
            alarmStop();  // 停止闹钟
        }
        isAlarmed = false;
    }
}
```

### 5.5 整点报时功能

#### 5.5.1 报时逻辑

- **倒计时阶段**（59 分 55 秒 - 59 分 59 秒）：每秒短音 100ms，共 5 次
- **整点阶段**（00 分 00 秒）：长音 1000ms

#### 5.5.2 报时时间范围

可设置报时生效的时间范围，避免夜间打扰。

- **默认范围**：8:00 - 20:00
- **跨天设置**：支持（如 22:00 - 6:00）

#### 5.5.3 冲突避免

- 如果闹钟开启且时间与整点报时冲突，整点报时自动跳过

### 5.6 亮度调节

#### 5.6.1 自动亮度

- **显示**：`br AU`
- **原理**：光敏电阻检测环境光强度
- **阈值**：
  - ADC > 2800：强光模式，亮度 = `strongBrightness`
  - ADC < 2300：弱光模式，亮度 = `weakBrightness`

#### 5.6.2 手动亮度

- **显示**：`br 0X`（X=1-8）
- **亮度等级**：1-8 级（8 级最亮）

#### 5.6.3 强光/弱光单独设置

| 设置项 | 显示 | 说明 |
|-------|------|------|
| 强光亮度 | `b1 XX` | 环境光强时的亮度（1-8） |
| 弱光亮度 | `b2 XX` | 环境光弱时的亮度（1-8） |

### 5.7 数据保存

所有设置保存在 **RTC 备份寄存器** 中，掉电不丢失。

| 索引 | 数据内容 | 范围 |
|-----|---------|------|
| 0x00-0x01 | 掉电标识 | 0xFA |
| 0x02 | 闹钟使能 | 0/1 |
| 0x03 | 闹钟小时 | 0-23 |
| 0x04 | 闹钟分钟 | 0-59 |
| 0x05 | 温度显示时长 | 0-15 秒 |
| 0x06 | 温度隐藏时长 | 0-30 秒 |
| 0x07 | 整点报时使能 | 0/1 |
| 0x08 | 报时开始时间 | 0-23 点 |
| 0x09 | 报时结束时间 | 0-23 点 |
| 0x0A | 亮度设置 | 0=自动，1-8=手动 |
| 0x0B | 强光亮度 | 1-8 |
| 0x0C | 弱光亮度 | 1-8 |

---

## 6. 设置流程

### 6.1 完整设置流程图

```
┌─────────────────────────────────────────────────────────────────┐
│                    正常显示状态 (时间/温度)                       │
│                         按 MODE 键进入设置                        │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │  设置小时 (H)    │ ← 按 SET 调整小时
                    │  显示：  HH      │
                    └─────────────────┘
                              │ 按 MODE
                              ▼
                    ┌─────────────────┐
                    │  设置分钟 (M)    │ ← 按 SET 调整分钟
                    │  显示：  MM      │
                    └─────────────────┘
                              │ 按 MODE（自动保存时间到 RTC）
                              ▼
                    ┌─────────────────┐
                    │  闹钟开关        │ ← 按 SET 切换 开/关
                    │  显示：AL On/oF  │
                    └─────────────────┘
                              │ 按 MODE
                              ▼
                    ┌─────────────────┐
                    │  设置闹钟小时    │ ← 按 SET 调整（如闹钟开启）
                    │  显示：  AH      │
                    └─────────────────┘
                              │ 按 MODE
                              ▼
                    ┌─────────────────┐
                    │  设置闹钟分钟    │ ← 按 SET 调整
                    │  显示：  AM      │
                    └─────────────────┘
                              │ 按 MODE
                              ▼
                    ┌─────────────────┐
                    │  温度显示时长    │ ← 按 SET 调整（0-15 秒）
                    │  显示：TS XX     │
                    └─────────────────┘
                              │ 按 MODE
                              ▼
                    ┌─────────────────┐
                    │  温度隐藏时长    │ ← 按 SET 调整（0-30 秒）
                    │  显示：TH XX     │
                    └─────────────────┘
                              │ 按 MODE
                              ▼
                    ┌─────────────────┐
                    │  亮度设置        │ ← 按 SET 调整（0=自动，1-8=手动）
                    │  显示：br AU/XX  │
                    └─────────────────┘
                              │ 按 MODE
                              ▼
                    ┌─────────────────┐
                    │  强光亮度        │ ← 按 SET 调整（1-8）
                    │  显示：b1 XX     │
                    └─────────────────┘
                              │ 按 MODE
                              ▼
                    ┌─────────────────┐
                    │  弱光亮度        │ ← 按 SET 调整（1-8）
                    │  显示：b2 XX     │
                    └─────────────────┘
                              │ 按 MODE
                              ▼
                    ┌─────────────────┐
                    │  整点报时开关    │ ← 按 SET 切换 开/关
                    │  显示：ro On/oF  │
                    └─────────────────┘
                              │ 按 MODE
                              ▼
                    ┌─────────────────┐
                    │  报时开始时间    │ ← 按 SET 调整（如报时开启）
                    │  显示：rS XX     │
                    └─────────────────┘
                              │ 按 MODE
                              ▼
                    ┌─────────────────┐
                    │  报时结束时间    │ ← 按 SET 调整
                    │  显示：re XX     │
                    └─────────────────┘
                              │ 按 MODE（保存所有设置并退出）
                              ▼
                    ┌─────────────────┐
                    │   返回正常显示   │
                    └─────────────────┘
```

### 6.2 快速操作指南

| 目的 | 操作步骤 |
|-----|---------|
| **调整时间** | MODE → 调小时 → MODE → 调分钟 → MODE（自动保存） |
| **设置闹钟** | MODE×3 → 开/关 → MODE → 调小时 → MODE → 调分钟 |
| **设置温度切换** | MODE×5 → 调显示时长 → MODE → 调隐藏时长 |
| **调整亮度** | MODE×7 → 调亮度 → MODE → 调强光 → MODE → 调弱光 |
| **设置整点报时** | MODE×9 → 开/关 → MODE → 调开始时间 → MODE → 调结束时间 |
| **快速退出** | 任意设置模式下，长按 MODE 键（>800ms） |
| **秒数归零** | SET 切换到秒数显示 → 按 MODE 键 |

---

## 7. 技术参数

### 7.1 时间参数

| 参数 | 值 |
|-----|---|
| 时间格式 | 24 小时制 |
| 小时范围 | 00-23 |
| 分钟范围 | 00-59 |
| 秒数范围 | 00-59 |

### 7.2 温度参数

| 参数 | 值 |
|-----|---|
| 测量范围 | 0-99℃ |
| 显示时长设置 | 0-15 秒 |
| 隐藏时长设置 | 0-30 秒 |
| 采样滤波 | 8 次滑动平均 |

### 7.3 亮度参数

| 参数 | 值 |
|-----|---|
| 亮度等级 | 1-8 级 |
| 强光 ADC 阈值 | 2800 |
| 弱光 ADC 阈值 | 2300 |
| 默认强光亮度 | 8 级 |
| 默认弱光亮度 | 1 级 |

### 7.4 按键参数

| 参数 | 值 |
|-----|---|
| 单击消抖时间 | 50ms |
| 长按判定时间 | 800ms |
| 长按重复间隔 | 250ms |

### 7.5 蜂鸣器参数

| 功能 | 响铃模式 |
|-----|---------|
| 闹钟 | 4 声短音（50ms 响/50ms 停）+ 500ms 休息，循环 |
| 整点报时（倒计时） | 100ms 短音，每秒一次，共 5 次 |
| 整点报时（整点） | 1000ms 长音 |

---

## 8. 常见问题

### Q1: 首次上电显示异常？

**A**: 首次上电时，时钟会自动恢复出厂设置：
- 时间：2015 年 1 月 1 日 00:00:00
- 闹钟：关闭
- 温度显示：2 秒显示 / 10 秒隐藏
- 亮度：手动 8 级
- 整点报时：关闭（8:00-20:00）

### Q2: 设置的时间不保存？

**A**: 确保完成以下操作：
1. 设置完分钟后按 MODE 键进入下一项（自动保存）
2. 或长按 MODE 键退出设置模式（自动保存）

### Q3: 温度显示不准确？

**A**: 温度检测采用 NTC 热敏电阻，可能受环境影响：
- 确保时钟远离热源
- 等待几分钟让温度稳定
- 温度采用 8 次采样平均，有一定延迟

### Q4: 闹钟不响？

**A**: 检查以下设置：
1. 闹钟是否开启（`AL On`）
2. 闹钟时间是否正确
3. 蜂鸣器是否正常工作

### Q5: 整点报时不响？

**A**: 检查以下设置：
1. 整点报时是否开启（`ro On`）
2. 当前时间是否在报时范围内
3. 是否与闹钟时间冲突（冲突时报时自动跳过）

### Q6: 亮度不自动调节？

**A**: 检查亮度设置：
- `br AU` = 自动亮度
- `br 0X` = 手动亮度（X=1-8）
- 如需自动调节，设置为 `br AU`

---

## 附录 A：出厂默认设置

| 设置项 | 默认值 |
|-------|-------|
| 闹钟 | 关闭 |
| 闹钟时间 | 00:00 |
| 温度显示时长 | 2 秒 |
| 温度隐藏时长 | 10 秒 |
| 整点报时 | 关闭 |
| 报时时间范围 | 8:00-20:00 |
| 亮度 | 手动 8 级 |
| 强光亮度 | 8 级 |
| 弱光亮度 | 1 级 |

---

## 附录 B：源代码关键函数

| 函数名 | 功能说明 | 源码位置 |
|-------|---------|---------|
| `refreshTimeDisplay()` | 刷新时间显示 | main.c:470 |
| `refreshSettingsDisplay()` | 刷新设置显示 | main.c:496 |
| `modeKeyClicked()` | MODE 键单击处理 | main.c:580 |
| `modeKeyLongPressed()` | MODE 键长按处理 | main.c:685 |
| `setKeyClicked()` | SET 键单击处理 | main.c:700 |
| `setKeyPresseRepeatReport()` | SET 键长按连发 | main.c:768 |
| `checkAlarm()` | 闹钟检查 | main.c:447 |
| `checkRingOnTime()` | 整点报时检查 | main.c:338 |
| `saveSettings()` | 保存设置到 RTC | main.c:267 |
| `resetSettings()` | 恢复出厂设置 | main.c:288 |

---

**文档版本**: 1.0  
**更新日期**: 2026 年 2 月 18 日  
**适用固件**: 基于 STM32F030F4 的 LED 时钟
